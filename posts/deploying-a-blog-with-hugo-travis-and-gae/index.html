<!doctype html><html><head><title>Deploying a blog with Hugo, TravisCI, and Google App Engine</title><link rel=stylesheet type=text/css href=css/index.css><script src=https://use.fontawesome.com/2e6d40bfc1.js></script>
<link href="https://fonts.googleapis.com/css?family=Noto+Serif" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Cinzel+Decorative" rel=stylesheet></head><body><div class=nav-bar><ul class=menu><li class=left><a href=/>HOME</a></li><li class=left><a href=/posts>BLOG</a></li><li class=left><a href=/talks>TALKS</a></li></ul></div><main><div class="col span_2"></div><div class="col span_8"><div class="section group"><h1>Deploying a blog with Hugo, TravisCI, and Google App Engine</h1><p class=small-font>October 31, 2017</p><div><p>Because I wanted to start blogging, I recently moved tech.taymor.io from a couple of static html and scss files* to a static site with a blog generated with <a href=https://gohugo.io/>Hugo</a>, deployed with <a href=https://cloud.google.com/appengine/>Google App Engine</a>. I hit a few snags trying to automate this site with <a href=https://travis-ci.org/>TravisCI</a> and Google App Engine, so I thought I&rsquo;d share my process.</p><h2 id=build-a-hugo-app-make-it-work-locally>Build a Hugo app, make it work locally</h2><p>I&rsquo;ll handwave over this a bit. I&rsquo;ve found Hugo to have a bit of a learning curve, but that&rsquo;s out of scope for this post. However, assuming you have a Hugo site that looks like you want it to when you serve with <code>hugo server</code>, then you&rsquo;re ready to deploy.</p><h2 id=integrate-with-travisci>Integrate with TravisCI</h2><p>Make your Github repo public. (You have to pay for private repos on Travis. If you care about that, you can probably integrate with mostly the same steps. Look at TravisCI docs for how to set up for a private repo)</p><p>Sign in to travisci.org with your Github account and enable Travis for your repo.</p><p>Write a no-op <code>Makefile</code> in the root dir of your git repository.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Makefile data-lang=Makefile><span style=display:flex><span><span style=color:#a6e22e>run</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	echo <span style=color:#e6db74>&#34;no-op makefile for travis&#34;</span>
</span></span></code></pre></div><p>Add a basic, empty golang .travis.yml file in your root dir like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>language</span>: <span style=color:#ae81ff>go</span>
</span></span><span style=display:flex><span><span style=color:#f92672>go</span>: <span style=color:#ae81ff>1.9</span>
</span></span></code></pre></div><p>Commit and push your changes to Github. Travis should kick off a new build automatically and you should see your <code>no-op makefile for travis</code> print out in the Travis run, which should go green. You now have a basic test and deployment pipeline set up, even if it does nothing. Every time you push your commits to Github, your pipeline will run.</p><h2 id=go-get-hugo-and-run-hugo-in-your-travis-file>Go get Hugo and run Hugo in your Travis file</h2><p>Add the following to your .travis.yml to get and build Hugo, following the Hugo <a href=https://gohugo.io/getting-started/installing/#quick-install>installation docs</a> for installing from source:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>before_install</span>:
</span></span><span style=display:flex><span>- <span style=color:#ae81ff>go get github.com/kardianos/govendor</span>
</span></span><span style=display:flex><span>- <span style=color:#ae81ff>govendor get github.com/gohugoio/hugo</span>
</span></span><span style=display:flex><span>- <span style=color:#ae81ff>go install github.com/gohugoio/hugo</span>
</span></span></code></pre></div><p>Update your Makefile to run Hugo in verbose mode. For good measure, add a clean step too.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Makefile data-lang=Makefile><span style=display:flex><span><span style=color:#a6e22e>run</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	hugo --verbose
</span></span><span style=display:flex><span><span style=color:#a6e22e>clean</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>	rm -rf public
</span></span></code></pre></div><p>The clean step will allow you to run <code>make clean</code> and remove your local generated site.</p><p>Try running <code>make</code> from the root dir of your repo. You&rsquo;ll see that hugo generates a public dir with all your static files.</p><h2 id=set-up-google-app-engine>Set up Google App Engine:</h2><p>Follow <a href=https://cloud.google.com/resource-manager/docs/creating-managing-projects>these docs to make a google project</a>.</p><p>Get the <a href=https://cloud.google.com/sdk/docs/#install_the_latest_cloud_tools_version_cloudsdk_current_version>gcloud cli here</a> for testing (Optional. You could just keep pushing to travis but that&rsquo;s a slower feedback loop)</p><p>Write an app.yaml file in your root repo dir like so:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#f92672>runtime</span>: <span style=color:#ae81ff>python27</span> <span style=color:#75715e># you don&#39;t care what the runtime is for static files. Python27 was easy</span>
</span></span><span style=display:flex><span><span style=color:#f92672>api_version</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>threadsafe</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>handlers</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>url</span>: <span style=color:#ae81ff>/$</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>static_files</span>: <span style=color:#ae81ff>public/index.html</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>upload</span>: <span style=color:#ae81ff>public/index.html</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>url</span>: <span style=color:#ae81ff>/posts</span> <span style=color:#75715e># serve the list of posts</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>static_files</span>: <span style=color:#ae81ff>public/posts/index.html</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>upload</span>: <span style=color:#ae81ff>public/posts/index.html</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>url</span>: <span style=color:#ae81ff>/posts/(.*)/</span> <span style=color:#75715e># serve each post</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>static_files</span>: <span style=color:#ae81ff>public/posts/\1/index.html</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>upload</span>: <span style=color:#ae81ff>public/posts/(.*)</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>url</span>: <span style=color:#ae81ff>/(.*)</span> <span style=color:#75715e># serve my css</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>static_files</span>: <span style=color:#ae81ff>public/\1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>upload</span>: <span style=color:#ae81ff>public/(.*)</span>
</span></span></code></pre></div><h3 id=what-is-the-appyaml-doing>What is the app.yaml doing?</h3><p>Primarily you&rsquo;re setting up handlers to server your content. The url is the endpoint covered by that handler. The static_files say what static file to serve from the files uploaded on the server. The upload_files indicates what files to upload to the server.</p><p>The regex capture groups <code>(.*)</code> in the url are then inserted in the places you see <code>\1</code> in the static_files section.</p><p>There&rsquo;s probably a more efficient, general way to set up your handlers. However, I had a very hard time getting the posts themself (and not just the posts index page) to serve, and this does work.</p><p>Try deploying your app with <code>gcloud app deploy</code>.
Check that all your pages deploy successfully, not just the index.</p><h2 id=deploy-to-google-app-engine-with-travis>Deploy to Google App Engine with Travis</h2><p><a href=https://docs.travis-ci.com/user/deployment/google-app-engine/>Travis&rsquo;s docs</a> on deploying to Google App Engine are pretty good. Be sure to only check in the encrypted key, not the unencrypted key!!</p><p>I did have some problems getting Travis to decrypt the key with the &ndash;add flag. This is what ultimately ended up working for me:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>before_install</span>:
</span></span><span style=display:flex><span>- <span style=color:#ae81ff>openssl aes-256-cbc -K $encrypted_6b8ed8e8b3dc_key -iv $encrypted_6b8ed8e8b3dc_iv</span>
</span></span><span style=display:flex><span>  -<span style=color:#ae81ff>in travis-ci-account-key.json.enc -out travis-ci-service-account-key.json</span>
</span></span><span style=display:flex><span>  -<span style=color:#ae81ff>d</span>
</span></span></code></pre></div><p>The travis.yml deploy section looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>deploy</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>provider</span>: <span style=color:#ae81ff>gae</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>keyfile</span>: <span style=color:#ae81ff>travis-ci-service-account-key.json</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>project</span>: <span style=color:#ae81ff>&lt;project-name&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>skip_cleanup</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><h2 id=tada>Tada!</h2><p>Your app should be now running on Google App Engine, and should be redeployed by TravisCI every time you push new commits to Github.</p><p>I highly recommend you set up https for your blog. To do that, you can either use lets encrypt or the <a href=https://cloud.google.com/appengine/docs/standard/python/securing-custom-domains-with-ssl>Google App Engine SSL beta</a> (which is what I chose).</p><p>Once you have an SSL certificate set up, go to your <code>app.yaml</code> file, and for each route, add <code>secure: always</code>. This will redirect http traffic to https.</p><p>This is what worked for my site. Let me know if you find it helpful.</p><h2 id=why-did-i-choose-this-tooling-stack>Why did I choose this tooling stack?</h2><p>I&rsquo;m an engineer on <a href=https://www.cloudfoundry.org/>Cloud Foundry</a>. <code>cf push my-app</code> is what I build. Why isn&rsquo;t this a tutorial on &ldquo;publishing a Hugo blog with Pivotal Web Services (Pivotal&rsquo;s hosted Cloud Foundry)&rdquo;?</p><p>The answer is twofold. First, I was curious about Google App Engine, and how it compares, if it does, to pushing an app with <code>cf push</code>. The answer is, for a low-traffic static &ldquo;app&rdquo; like this blog, I don&rsquo;t think it much matters. At Cloud Foundry, we&rsquo;re focused on the experience of operators at large companies, and their developers. For a few static files, if you don&rsquo;t care who operates your platform, I don&rsquo;t see any relevant difference.</p><p>So then we get to the second and main answer: Price. I have an employee Pivotal Web Services account, but you probably don&rsquo;t. And for a single instance of a tiny, static blog like this with moderate traffic, Google App Engine&rsquo;s free tier can&rsquo;t be beat. PWS&rsquo;s strengths lie elsewhere.</p><p>Why did I use Google App Engine over hosting the static files in Google Cloud Storage? Simply put, https. You can&rsquo;t use https to serve a Cloud Storage website, and I beleive the whole web should be moving towards https.</p><p>If this site ends up with enough traffic to need to move past the free tier on Google App Engine someday, maybe you&rsquo;ll see another tutorial on how to port it elsewhere. For now, this stack is cheap (I pay only for my domain name) and fairly easy.</p><p>tl:dr I was curious and it was cheap.</p><p>*And if you&rsquo;re really curious, my previous &ldquo;stack&rdquo; for tech.taymor.io was a single Google Cloud Platform instance into which I would ssh and git pull and restart the apache server when I had updates. I know, it&rsquo;s horrifying. But it worked okay enough for a site I almost never updated. It&rsquo;s much much better and easier now, and it lets me add a blog I might update more frequently.</p></div></div><div class="col span_2"></div></main><div class=footer><p>Copyright 2022 Caroline Taymor. Powered by <a href=https://gohugo.io/>Hugo</a> with the <a href=https://github.com/ctaymor/bisl-theme>Bisl</a> theme.</p></div></body></html>